name: Network Configuration CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible paramiko yamllint ansible-lint

      - name: YAML Lint
        run: |
          yamllint ansible/host_vars/
          yamllint ansible/group_vars/
          yamllint ansible/playbooks/

      - name: Ansible Lint
        run: |
          ansible-lint ansible/playbooks/*.yml

      - name: Validate Templates
        run: |
          ansible-playbook ansible/playbooks/configure_routers.yml --syntax-check

      - name: Check for IP conflicts
        run: |
          python -c '
          import yaml
          import glob
          import ipaddress
          ips = []
          for f in glob.glob("ansible/host_vars/*.yml"):
              with open(f) as file:
                  data = yaml.safe_load(file)
                  if "router_config" in data and "interfaces" in data["router_config"]:
                      for iface in data["router_config"]["interfaces"].get("ethernet", {}).values():
                          if "address" in iface:
                              ips.append(iface["address"])
          ip_set = set()
          for ip in ips:
              addr = ipaddress.ip_interface(ip).ip
              if addr in ip_set:
                  raise Exception(f"Duplicate IP found: {addr}")
              ip_set.add(addr)
          '

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    environment: production
    steps:
      - name: Deploy notification
        run: |
          echo "Configuration passed all tests and is ready for deployment"
          echo "Manual approval required in production environment"