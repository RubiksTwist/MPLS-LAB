---
# Connectivity Check with Azure Key Vault Integration
# This version fetches the VyOS password from Azure Key Vault before connecting to routers
#
# Prerequisites:
# 1. Azure Key Vault configured with 'vyos-password' secret
# 2. Environment variables set: AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID, AZURE_KEYVAULT_NAME
# 3. Load variables: export $(grep -v '^#' .env | grep -v '^$' | xargs)
#
# Usage:
#   ansible-playbook ansible/playbooks/connectivity_check_keyvault.yml

- name: Fetch Credentials from Azure Key Vault
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Verify Azure environment variables are set
      ansible.builtin.assert:
        that:
          - lookup('env', 'AZURE_CLIENT_ID') | length > 0
          - lookup('env', 'AZURE_CLIENT_SECRET') | length > 0
          - lookup('env', 'AZURE_TENANT_ID') | length > 0
          - lookup('env', 'AZURE_KEYVAULT_NAME') | length > 0
        fail_msg: |
          Azure environment variables not set. Please run:
          export $(grep -v '^#' .env | grep -v '^$' | xargs)
        success_msg: "Azure environment variables are configured"

    - name: Fetch VyOS password from Azure Key Vault
      ansible.builtin.shell: |
        python3 << 'PYTHON_EOF'
        import os
        from azure.keyvault.secrets import SecretClient
        from azure.identity import ClientSecretCredential

        # Get credentials from environment
        tenant_id = os.environ['AZURE_TENANT_ID']
        client_id = os.environ['AZURE_CLIENT_ID']
        client_secret = os.environ['AZURE_CLIENT_SECRET']
        vault_name = os.environ['AZURE_KEYVAULT_NAME']

        # Create credential
        credential = ClientSecretCredential(
            tenant_id=tenant_id,
            client_id=client_id,
            client_secret=client_secret
        )

        # Connect to Key Vault
        vault_url = f"https://{vault_name}.vault.azure.net"
        client = SecretClient(vault_url=vault_url, credential=credential)

        # Retrieve secret
        secret = client.get_secret("vyos-password")
        print(secret.value)
        PYTHON_EOF
      register: keyvault_result
      changed_when: false
      no_log: true  # Don't log the password
      environment:
        AZURE_CLIENT_ID: "{{ lookup('env', 'AZURE_CLIENT_ID') }}"
        AZURE_CLIENT_SECRET: "{{ lookup('env', 'AZURE_CLIENT_SECRET') }}"
        AZURE_TENANT_ID: "{{ lookup('env', 'AZURE_TENANT_ID') }}"
        AZURE_KEYVAULT_NAME: "{{ lookup('env', 'AZURE_KEYVAULT_NAME') }}"

    - name: Set VyOS password as fact for all hosts
      ansible.builtin.set_fact:
        ansible_password: "{{ keyvault_result.stdout | trim }}"
      no_log: true
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"

    - name: Display success message
      ansible.builtin.debug:
        msg: "âœ“ Successfully retrieved password from Azure Key Vault and configured for {{ groups['all'] | length }} hosts"

- name: Verify Network Connectivity and Configuration
  hosts: all
  gather_facts: false
  tasks:
    - name: Check Management Interface Connectivity
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10
      delegate_to: localhost
      register: ssh_check
      ignore_errors: true

    - name: Report SSH Connectivity Status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} {{ 'is' if ssh_check.failed == false else 'is NOT' }} reachable"

    - name: Verify Interface Configuration Syntax
      vyos.vyos.vyos_command:
        commands:
          - show configuration commands | grep interfaces
      register: config_check
      ignore_errors: true

    - name: Report Configuration Check Status
      ansible.builtin.debug:
        msg: >
          Configuration syntax for {{ inventory_hostname }} is
          {{ 'valid' if not config_check.changed else 'INVALID' }}
      when: config_check is defined

    - name: Check for IP Address Conflicts
      ansible.builtin.set_fact:
        ip_addresses: >-
          {{
            groups['all']
            | map('extract', hostvars)
            | selectattr('router_config', 'defined')
            | map(attribute='router_config.interfaces.ethernet')
            | select('defined')
            | map('dict2items')
            | list
            | sum(start=[])
            | map(attribute='value.address')
            | list
          }}
      delegate_to: localhost
      run_once: true

    - name: Report IP Conflicts
      ansible.builtin.debug:
        msg: "WARNING: Duplicate IP found: {{ item }}"
      when: ip_addresses | select('match', '^' + item + '$') | list | length > 1
      loop: "{{ ip_addresses | default([]) }}"
      delegate_to: localhost
      run_once: true

    - name: Fail if Any Tests Failed
      ansible.builtin.fail:
        msg: "Pre-deployment tests failed. Please check the output above."
      when: ssh_check.failed or (config_check is defined and config_check.changed)
