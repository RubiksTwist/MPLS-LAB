---
- name: Ping between VyOS routers
  hosts: vyos
  gather_facts: false
  tasks:
    - name: Build peer management IP list
      ansible.builtin.set_fact:
        peers: >-
          {{ groups['vyos']
             | reject('equalto', inventory_hostname)
             | map('extract', hostvars, 'ansible_host')
             | list }}

    - name: Show peers to be pinged
      ansible.builtin.debug:
        var: peers
        verbosity: 3

    - name: Ping each peer from the router
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ item }} count 3"
      loop: "{{ peers }}"
      register: ping_outputs
      ignore_errors: true

    - name: Build list of failed peers
      ansible.builtin.set_fact:
        failed_peers: >-
          {{ ping_outputs.results
             | selectattr('failed', 'equalto', true)
             | map(attribute='item')
             | list }}

    - name: Summary when all pings succeed
      ansible.builtin.debug:
        msg: "All peers reachable from {{ inventory_hostname }} ({{ peers | length }} tested)"
      when: (failed_peers | length) == 0

    - name: Summary when some pings fail
      ansible.builtin.debug:
        msg: "Unreachable from {{ inventory_hostname }}: {{ failed_peers | join(', ') }}"
      when: (failed_peers | length) > 0

    - name: Fail if any ping failed
      ansible.builtin.fail:
        msg: "One or more ping tests failed from {{ inventory_hostname }}. See summary above."
      when: ping_outputs.results | selectattr('failed', 'equalto', true) | list | length > 0
