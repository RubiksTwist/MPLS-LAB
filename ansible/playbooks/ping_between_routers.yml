---
- name: Ping between VyOS routers
  hosts: vyos
  gather_facts: false
  tasks:
    - name: Build peer management IP list
      ansible.builtin.set_fact:
        peers: >-
          {{ groups['vyos']
             | reject('equalto', inventory_hostname)
             | map('extract', hostvars, 'ansible_host')
             | list }}

    - name: Show peers to be pinged
      ansible.builtin.debug:
        var: peers

    - name: Ping each peer from the router
      vyos.vyos.vyos_command:
        commands:
          - "ping {{ item }} count 3"
      loop: "{{ peers }}"
      register: ping_outputs
      ignore_errors: true

    - name: Summarize successful pings
      ansible.builtin.debug:
        msg: "{{ item.item }} => SUCCESS; stdout={{ item.stdout[0] | default('') }}"
      loop: "{{ ping_outputs.results }}"
      when: item.failed is not defined or not item.failed

    - name: Summarize failed pings
      ansible.builtin.debug:
        msg: "{{ item.item }} => FAIL; stdout={{ item.stdout[0] | default('') }}"
      loop: "{{ ping_outputs.results }}"
      when: item.failed | default(false)

    - name: Fail if any ping failed
      ansible.builtin.fail:
        msg: "One or more ping tests failed from {{ inventory_hostname }}. See summary above."
      when: ping_outputs.results | selectattr('failed', 'equalto', true) | list | length > 0
