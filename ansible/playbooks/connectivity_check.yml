---
- name: Verify Network Connectivity and Configuration
  hosts: all
  gather_facts: false
  tasks:
    - name: Check Management Interface Connectivity
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 10
      delegate_to: localhost
      register: ssh_check
      ignore_errors: true

    - name: Report SSH Connectivity Status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} {{ 'is' if ssh_check.failed == false else 'is NOT' }} reachable"

    - name: Verify Interface Configuration Syntax
      vyos.vyos.vyos_command:
        commands:
          - show configuration commands | grep interfaces
      register: config_check
      ignore_errors: true

    - name: Report Configuration Check Status
      ansible.builtin.debug:
        msg: >
          Configuration syntax for {{ inventory_hostname }} is
          {{ 'valid' if not config_check.changed else 'INVALID' }}
      when: config_check is defined

    - name: Check for IP Address Conflicts
      ansible.builtin.set_fact:
        ip_addresses: "{{ ip_addresses | default([]) + [item.address] }}"
      loop: >-
        {{ router_config.interfaces.ethernet |
           dict2items |
           json_query('[].value.address') }}
      when: router_config.interfaces is defined
      delegate_to: localhost
      run_once: true

    - name: Report IP Conflicts
      ansible.builtin.debug:
        msg: "WARNING: Duplicate IP found: {{ item }}"
      when: ip_addresses | select('match', '^' + item + '$') | list | length > 1
      loop: "{{ ip_addresses | default([]) }}"
      delegate_to: localhost
      run_once: true

    - name: Fail if Any Tests Failed
      ansible.builtin.fail:
        msg: "Pre-deployment tests failed. Please check the output above."
      when: ssh_check.failed or (config_check is defined and config_check.changed)
