---
- name: Configure MPLS Network with OSPF, BGP, and LDP
  hosts: all
  gather_facts: false
  tasks:
    - name: Display configuration banner
      debug:
        msg: "Configuring {{ inventory_hostname }} as {{ 'Provider Core' if inventory_hostname in ['P1', 'P2'] else 'Provider Edge' if inventory_hostname in ['PE1', 'PE2'] else 'Customer Edge' }} router"

    - name: Clear existing routing protocols (safe reconfiguration)
      vyos.vyos.vyos_config:
        lines:
          - delete protocols ospf
          - delete protocols bgp
          - delete protocols mpls
          - delete vrf
        save: false
      ignore_errors: true

    - name: Generate routing configuration
      set_fact:
        routing_config: "{{ lookup('template', '../templates/routing.j2') }}"

    - name: Apply routing configuration (creates VRFs first)
      vyos.vyos.vyos_config:
        lines: "{{ routing_config.split('\n') | select('match', '^set .*') | list }}"
        save: false

    - name: Generate interface configuration
      set_fact:
        interface_config: "{{ lookup('template', '../templates/interfaces.j2') }}"

    - name: Apply interface configuration (assigns interfaces to VRFs)
      vyos.vyos.vyos_config:
        lines: "{{ interface_config.split('\n') | select('match', '^set .*') | list }}"
        save: false

    - name: Commit and save configuration
      vyos.vyos.vyos_config:
        save: true

    - name: Wait for protocols to stabilize
      pause:
        seconds: 5

- name: Verify MPLS Configuration
  hosts: all
  gather_facts: false
  tasks:
    - name: Check OSPF neighbors (Provider routers only)
      vyos.vyos.vyos_command:
        commands:
          - show ip ospf neighbor
      register: ospf_neighbors
      when: inventory_hostname in ['P1', 'P2', 'PE1', 'PE2']

    - name: Display OSPF neighbors
      debug:
        var: ospf_neighbors.stdout_lines[0]
      when: inventory_hostname in ['P1', 'P2', 'PE1', 'PE2']

    - name: Check BGP summary
      vyos.vyos.vyos_command:
        commands:
          - show ip bgp summary
      register: bgp_summary
      when: inventory_hostname in ['CE1', 'CE2', 'PE1', 'PE2']

    - name: Display BGP summary
      debug:
        var: bgp_summary.stdout_lines[0]
      when: inventory_hostname in ['CE1', 'CE2', 'PE1', 'PE2']

    - name: Check MPLS LDP bindings (Provider routers only)
      vyos.vyos.vyos_command:
        commands:
          - show mpls ldp binding
      register: mpls_bindings
      when: inventory_hostname in ['P1', 'P2', 'PE1', 'PE2']
      ignore_errors: true

    - name: Display MPLS LDP bindings
      debug:
        var: mpls_bindings.stdout_lines[0]
      when: inventory_hostname in ['P1', 'P2', 'PE1', 'PE2'] and mpls_bindings is succeeded

    - name: Check LDP neighbors (Provider routers only)
      vyos.vyos.vyos_command:
        commands:
          - show mpls ldp neighbor
      register: ldp_neighbors
      when: inventory_hostname in ['P1', 'P2', 'PE1', 'PE2']
      ignore_errors: true

    - name: Display LDP neighbors
      debug:
        var: ldp_neighbors.stdout_lines[0]
      when: inventory_hostname in ['P1', 'P2', 'PE1', 'PE2'] and ldp_neighbors is succeeded
